<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        display: flex;
        flex-wrap: wrap;
        height: 100vh;
        width: 100vw;
        background-color: #d3d3d3;
      }
      .vid {
        height: 300px;
        width: 300px;
        object-fit: contain;
      }
      .local {
        border: #f00 solid 5px;
      }
    </style>
  </head>
  <body>
    <div id="main-container" class="container"></div>
    <script src="./mediasoup-simple-client-bundle.js"></script>
    <script>
      function addANewVideoElement(track, isLocal) {
        const newVideoElement = document.createElement("video");
        newVideoElement.muted = isLocal ? true : false;
        newVideoElement.playsInline = true;
        newVideoElement.autoplay = true;
        newVideoElement.controls = true;
        newVideoElement.srcObject = new MediaStream([track]);
        newVideoElement.classList.add("vid");
        if (isLocal) {
          newVideoElement.classList.add("local");
        }
        const container = document.getElementById("main-container");
        container.appendChild(newVideoElement);
        return newVideoElement;
      }

      let consumerToVideoElementMap = {};
      function addVideoElementAgainstId(Id, videoElement) {
        consumerToVideoElementMap[Id] = videoElement;
      }
      function removeElementForId(Id) {
        const element = consumerToVideoElementMap[Id];
        if (!element) {
          return;
        }
        const container = document.getElementById("main-container");
        container.removeChild(element);
        delete consumerToVideoElementMap[Id];
      }

      (async () => {
        //////// SECTION 1 INITIALIZATION ///////
        // Initializing connection to the server.
        let roomClient = new mediasoup.RoomClient({
          roomId: "p6afwjkb",
          peerId: `${(Math.random() * 1000) | 0}`,
          displayName: `${(new Date().getTime() / 1000) | 0}`,
          baseUrl: "ws://localhost:4443",
          mode: mediasoup.MODES.AUDIO_ONLY,
          useSimulcast: true,
          forceH264: false,
          producerTopics:
            location.hash === "#teacher" ? ["teacher"] : ["students"],
          consumerTopics:
            location.hash === "#teacher"
              ? ["students", "teacher"]
              : ["teacher"],
        });
        await roomClient.join();
        //////// SECTION 2 PRODUCER EVENTS ///////
        // Listen for events on 'PRODUCER's. Local tracks.
        roomClient.on(mediasoup.EVENTS.PRODUCER.NEW_PRODUCER, (producer) => {
          const track = producer.track;
          // Producers are local tracks
          const element = addANewVideoElement(track, true);
          addVideoElementAgainstId(producer.id, element);
        });
        // Listen for producers being removed. disableMic, disableShare, disableWebcam
        roomClient.on(mediasoup.EVENTS.PRODUCER.REMOVE_PRODUCER, (producer) => {
          removeElementForId(producer.id);
        });
        //////// SECTION 3 CONSUMER EVENTS ///////
        // Listen for events on 'CONSUMERS's. Remote tracks.
        roomClient.on(mediasoup.EVENTS.CONSUMER.NEW_CONSUMER, (data) => {
          const { consumer } = data;
          // Consumers are remote tracks
          const element = addANewVideoElement(consumer.track, false);
          addVideoElementAgainstId(consumer.id, element);
        });
        // Listen for consumers being removed.
        roomClient.on(mediasoup.EVENTS.CONSUMER.REMOVE_CONSUMER, (consumer) => {
          removeElementForId(consumer.id);
        });
        //////// SECTION 4 SUBSCRIBE TO ALL EVENTS ///////
        // Print all supported events
        console.log("Here's a list of mediasoup events supported.");
        console.log(mediasoup.EVENTS);
        //Subscribing to all events
        // First we subscribe to all the event groups.
        // NOTE: ERROR is not an event group
        let eventGroups = Object.keys(mediasoup.EVENTS);
        eventGroups = eventGroups.filter((e) => e !== "ERROR");
        for (const group of eventGroups) {
          let events = Object.keys(mediasoup.EVENTS[group]);
          // For each group we subscribe to all its
          // events.
          for (const ev of events) {
            roomClient.on(ev, (data) => {
              console.log(`Event Group: ${group} Event: ${ev}`, data);
            });
          }
        }
        // We subscribe to the ERROR event separately.
        roomClient.on(mediasoup.EVENTS.ERROR, (data) => {
          console.log(`Event: ERROR`, data);
        });

        window.roomClient = roomClient;
      })();
    </script>
  </body>
</html>
